# 정산 시스템 구현 체크리스트

## 🎯 핵심 목표

1. **수수료 수익 집계**: 거래소가 벌어들인 총 수수료 수익을 일별/월별로 집계
2. **복식부기 검증**: 모든 거래 내역이 정확한지 검증 (차변 = 대변)
3. **정산 리포트**: 일별/월별 정산 리포트 생성

---

## ✅ Phase 1: 수수료 기록 및 수익 집계 (최우선)

### 1.1 `trade_fees` 테이블 생성

**목적**: 각 거래에서 발생한 수수료를 상세히 기록

**필요한 이유**:
- 거래 금액에 따라 수수료 금액이 다름 (1000달러 → 0.1달러, 100000달러 → 10달러)
- 각 거래마다 실제 수수료 금액을 기록해야 총 수수료 수익을 집계할 수 있음

**스키마**:
```sql
CREATE TABLE trade_fees (
    id BIGSERIAL PRIMARY KEY,
    trade_id BIGINT NOT NULL REFERENCES trades(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    fee_type VARCHAR(20) NOT NULL CHECK (fee_type IN ('buyer', 'seller')),
    fee_rate DECIMAL(10, 6) NOT NULL,                  -- 적용된 수수료율 (예: 0.0001 = 0.01%)
    fee_amount DECIMAL(30, 9) NOT NULL,                 -- 실제 수수료 금액 (예: 0.1달러 또는 10달러)
    fee_mint VARCHAR(255) NOT NULL,                     -- 수수료가 차감된 자산 (SOL 또는 USDT)
    trade_value DECIMAL(30, 9) NOT NULL,                 -- 거래 금액 (수수료 계산 기준)
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    INDEX idx_trade_fees_trade_id (trade_id),
    INDEX idx_trade_fees_user_id (user_id),
    INDEX idx_trade_fees_created_at (created_at)
);
```

**구현 위치**: 
- `KafkaOrderEventConsumer.handleTradeExecutedWithSnapshot()`
- 체결 이벤트 처리 시 수수료 계산 후 `trade_fees` 테이블에 저장

**체크리스트**:
- [ ] `TradeFee` 엔티티 생성
- [ ] `TradeFeeRepository` 생성
- [ ] `KafkaOrderEventConsumer`에 수수료 기록 로직 추가
- [ ] 마이그레이션 파일 생성

### 1.2 수수료 수익 집계

**목적**: 거래소가 벌어들인 총 수수료 수익을 일별/월별로 집계

**집계 항목**:
- 일별 총 수수료 수익 (USDT 기준)
- 월별 총 수수료 수익 (USDT 기준)
- 거래쌍별 수수료 수익 (SOL/USDT, BTC/USDT 등)
- 사용자별 수수료 납부 내역

**구현 위치**: `SettlementService.calculateFeeRevenue()`

**체크리스트**:
- [ ] `SettlementService.calculateDailyFeeRevenue()` 구현
- [ ] `SettlementService.calculateMonthlyFeeRevenue()` 구현
- [ ] 거래쌍별 수수료 수익 집계 로직 구현

---

## ✅ Phase 2: 복식부기 검증 (정확도 보장)

### 2.1 복식부기 검증 로직

**목적**: 모든 거래 내역이 정확한지 검증 (차변 = 대변)

**검증 항목**:

1. **잔고 검증**
   ```
   초기 잔고 + 입금 - 출금 - 수수료 = 최종 잔고
   ```

2. **거래 검증**
   ```
   매수자 지출 = 매도자 수입
   매수자 수입 = 매도자 지출
   ```

3. **수수료 검증**
   ```
   매수자 수수료 + 매도자 수수료 = 거래소 수익
   ```

4. **전체 시스템 검증**
   ```
   모든 사용자 잔고 합계 + 거래소 수수료 수익 = 초기 자산 총합 + 입금 총합 - 출금 총합
   ```

**구현 위치**: `SettlementService.validateDoubleEntryBookkeeping()`

**체크리스트**:
- [ ] 잔고 검증 로직 구현
- [ ] 거래 검증 로직 구현
- [ ] 수수료 검증 로직 구현
- [ ] 전체 시스템 검증 로직 구현
- [ ] 검증 실패 시 상세 에러 로그 기록

---

## ✅ Phase 3: 정산 집계 테이블

### 3.1 `settlements` 테이블 생성

**목적**: 일별/월별 정산 요약 정보 저장

**스키마**:
```sql
CREATE TABLE settlements (
    id BIGSERIAL PRIMARY KEY,
    settlement_date DATE NOT NULL,                     -- 정산일 (YYYY-MM-DD)
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,    -- 총 거래량 (USDT)
    total_fee_revenue DECIMAL(30, 9) NOT NULL DEFAULT 0, -- 총 수수료 수익 (USDT)
    total_users BIGINT NOT NULL DEFAULT 0,             -- 거래한 사용자 수
    base_mint VARCHAR(255),                             -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    validation_status VARCHAR(20) DEFAULT 'pending'    -- 'pending', 'validated', 'failed'
        CHECK (validation_status IN ('pending', 'validated', 'failed')),
    validation_error TEXT,                              -- 검증 실패 시 에러 메시지
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    validated_at TIMESTAMPTZ,
    
    UNIQUE(settlement_date, settlement_type, base_mint, quote_mint),
    INDEX idx_settlements_date (settlement_date),
    INDEX idx_settlements_type (settlement_type)
);
```

**체크리스트**:
- [ ] `Settlement` 엔티티 생성
- [ ] `SettlementRepository` 생성
- [ ] 일별 정산 집계 로직 구현
- [ ] 월별 정산 집계 로직 구현
- [ ] 마이그레이션 파일 생성

### 3.2 `user_settlements` 테이블 생성

**목적**: 사용자별 일별/월별 거래 및 수수료 내역 요약

**스키마**:
```sql
CREATE TABLE user_settlements (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    settlement_date DATE NOT NULL,
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 사용자 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,     -- 사용자 총 거래량 (USDT)
    total_fees_paid DECIMAL(30, 9) NOT NULL DEFAULT 0,  -- 사용자가 지불한 총 수수료
    base_mint VARCHAR(255),                             -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(user_id, settlement_date, settlement_type, base_mint, quote_mint),
    INDEX idx_user_settlements_user_id (user_id),
    INDEX idx_user_settlements_date (settlement_date)
);
```

**체크리스트**:
- [ ] `UserSettlement` 엔티티 생성
- [ ] `UserSettlementRepository` 생성
- [ ] 사용자별 일별 정산 집계 로직 구현
- [ ] 사용자별 월별 정산 집계 로직 구현
- [ ] 마이그레이션 파일 생성

---

## ✅ Phase 4: 정산 프로세스 개선

### 4.1 일별 정산 프로세스 개선

**실행 시점**: 매일 자정 (00:00:00)

**처리 순서**:

1. **스냅샷 생성** (기존 ✅)
   - `balance_snapshots` 생성
   - `position_snapshots` 생성

2. **거래 집계** (신규)
   - 전일(`settlement_date - 1`) 모든 거래 조회 (`trades` 테이블)
   - 거래 건수, 거래량 집계

3. **수수료 집계** (신규)
   - 전일 모든 수수료 조회 (`trade_fees` 테이블)
   - 총 수수료 수익 계산 (USDT 기준)

4. **복식부기 검증** (신규)
   - 잔고 검증
   - 거래 검증
   - 수수료 검증
   - 전체 시스템 검증

5. **정산 데이터 저장** (신규)
   - `settlements` 테이블에 일별 정산 데이터 저장
   - `user_settlements` 테이블에 사용자별 정산 데이터 저장

6. **검증 실패 시 알림** (신규)
   - 검증 실패 시 관리자에게 알림
   - 에러 로그 상세 기록

**체크리스트**:
- [ ] `SettlementScheduler.createDailySnapshots()` 개선
- [ ] 거래 집계 로직 추가
- [ ] 수수료 집계 로직 추가
- [ ] 복식부기 검증 로직 통합
- [ ] 정산 데이터 저장 로직 추가

### 4.2 월별 정산 프로세스 (신규)

**실행 시점**: 매월 1일 자정 (00:00:00)

**처리 순서**:
1. 전월 모든 일별 정산 데이터 집계
2. 월별 집계 계산
3. 복식부기 검증 (월별)
4. `settlements` 테이블에 월별 정산 데이터 저장
5. `user_settlements` 테이블에 사용자별 월별 정산 저장

**체크리스트**:
- [ ] `SettlementScheduler.createMonthlySettlements()` 구현
- [ ] 월별 집계 로직 구현
- [ ] 월별 복식부기 검증 로직 구현

---

## ✅ Phase 5: 정산 리포트 생성

### 5.1 일별 정산 리포트

**포함 내용**:
- 일별 거래 건수 및 거래량
- 일별 수수료 수익
- 거래쌍별 통계
- 사용자별 상위 거래자
- 복식부기 검증 결과

**체크리스트**:
- [ ] `SettlementReportService.generateDailyReport()` 구현
- [ ] 리포트 데이터 구조 정의
- [ ] JSON 형식 리포트 생성

### 5.2 월별 정산 리포트

**포함 내용**:
- 월별 거래 건수 및 거래량
- 월별 수수료 수익
- 일별 추이 그래프 데이터
- 거래쌍별 성과 분석
- 사용자별 월별 통계

**체크리스트**:
- [ ] `SettlementReportService.generateMonthlyReport()` 구현
- [ ] 월별 집계 데이터 생성

### 5.3 사용자별 정산 리포트

**포함 내용**:
- 사용자 거래 내역
- 사용자 수수료 납부 내역
- 사용자 잔고 변동 내역
- 세금 신고용 데이터

**체크리스트**:
- [ ] `SettlementReportService.generateUserDailyReport()` 구현
- [ ] 사용자별 리포트 데이터 생성

---

## ✅ Phase 6: API 엔드포인트

### 6.1 수수료 수익 조회 API

**체크리스트**:
- [ ] GET `/api/settlement/revenue/daily?date=2026-01-28` - 일별 수수료 수익 조회
- [ ] GET `/api/settlement/revenue/monthly?year=2026&month=1` - 월별 수수료 수익 조회
- [ ] GET `/api/settlement/revenue/by-pair?date=2026-01-28` - 거래쌍별 수수료 수익 조회

### 6.2 정산 검증 API

**체크리스트**:
- [ ] POST `/api/settlement/validate/{date}` - 정산 검증 실행
- [ ] GET `/api/settlement/validation-status/{date}` - 검증 상태 조회

### 6.3 정산 리포트 API

**체크리스트**:
- [ ] GET `/api/settlement/report/daily/{date}` - 일별 리포트 생성
- [ ] GET `/api/settlement/report/monthly/{year}/{month}` - 월별 리포트 생성
- [ ] GET `/api/settlement/report/user/{userId}/{date}` - 사용자별 리포트 생성

---

## 📋 구현 순서 요약

### Step 1: 수수료 기록 (최우선)
1. `trade_fees` 테이블 생성
2. `TradeFee` 엔티티 및 Repository 생성
3. `KafkaOrderEventConsumer`에 수수료 기록 로직 추가

### Step 2: 복식부기 검증
4. 복식부기 검증 로직 구현
5. 검증 실패 시 에러 처리

### Step 3: 정산 집계
6. `settlements` 테이블 생성 및 일별 집계 구현
7. `user_settlements` 테이블 생성 및 사용자별 집계 구현
8. 수수료 수익 집계 로직 구현

### Step 4: 정산 프로세스 통합
9. 일별 정산 프로세스 개선 (스냅샷 + 집계 + 검증)
10. 월별 정산 프로세스 구현

### Step 5: 리포트 및 API
11. 정산 리포트 생성 로직 구현
12. API 엔드포인트 구현

---

## 🎯 핵심 요구사항 재확인

1. **수수료 수익 집계**: ✅ 각 거래마다 실제 수수료 금액 기록 → 일별/월별 집계
2. **복식부기 검증**: ✅ 모든 거래 내역 정확성 검증 (차변 = 대변)
3. **정산 리포트**: ✅ 일별/월별 정산 리포트 생성
