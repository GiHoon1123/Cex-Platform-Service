# 정산 관련 테이블 정리

## 1. 핵심 정산 테이블

### 1.1 `user_balances` - 사용자 잔고 테이블

**역할**: 사용자가 보유한 각 자산의 잔고를 관리 (거래소 내부 잔고)

**스키마**:

```sql
CREATE TABLE user_balances (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    mint_address VARCHAR(255) NOT NULL,              -- 자산 식별자 (SOL, USDT 등)
    available DECIMAL(30, 9) NOT NULL DEFAULT 0,     -- 사용 가능한 잔고
    locked DECIMAL(30, 9) NOT NULL DEFAULT 0,        -- 주문에 잠긴 잔고
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, mint_address)
);
```

**정산 활용**:

- 사용자별 자산 잔고 조회
- 일별/월별 잔고 스냅샷 생성 가능
- 잔고 변동 추적

---

### 1.2 `orders` - 주문 테이블

**역할**: 사용자가 생성한 매수/매도 주문 내역

**스키마**:

```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    order_type VARCHAR(20) NOT NULL CHECK (order_type IN ('buy', 'sell')),
    order_side VARCHAR(20) NOT NULL CHECK (order_side IN ('limit', 'market')),
    base_mint VARCHAR(255) NOT NULL,
    quote_mint VARCHAR(255) NOT NULL DEFAULT 'USDT',
    price DECIMAL(30, 9),                              -- 지정가 가격 (시장가는 NULL)
    amount DECIMAL(30, 9) NOT NULL,                    -- 주문 수량
    filled_amount DECIMAL(30, 9) NOT NULL DEFAULT 0,   -- 체결된 수량
    filled_quote_amount DECIMAL(20, 8) NOT NULL DEFAULT 0,  -- 체결된 금액 (USDT)
    status VARCHAR(50) NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'partial', 'filled', 'cancelled', 'rejected')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**정산 활용**:

- 사용자별 거래 내역 집계
- 주문별 수수료 계산
- 거래량 통계

---

### 1.3 `trades` - 체결 내역 테이블

**역할**: 실제로 발생한 거래(체결) 내역

**스키마**:

```sql
CREATE TABLE trades (
    id BIGSERIAL PRIMARY KEY,
    buy_order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    sell_order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    buyer_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    seller_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    base_mint VARCHAR(255) NOT NULL,
    quote_mint VARCHAR(255) NOT NULL,
    price DECIMAL(30, 9) NOT NULL,                     -- 체결 가격
    amount DECIMAL(30, 9) NOT NULL,                    -- 체결 수량
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**정산 활용**:

- 일별/월별 거래량 집계
- 거래쌍별 거래량 통계
- 사용자별 거래 내역 조회
- 수수료 계산의 기초 데이터

---

### 1.4 `fee_configs` - 수수료 설정 테이블

**역할**: 거래소의 거래 수수료 설정 관리

**스키마**:

```sql
CREATE TABLE fee_configs (
    id BIGSERIAL PRIMARY KEY,
    base_mint VARCHAR(255),                           -- NULL이면 전체 적용
    quote_mint VARCHAR(255),                          -- NULL이면 전체 적용
    fee_rate DECIMAL(10, 6) NOT NULL DEFAULT 0.0001,  -- 수수료율 (0.0001 = 0.01%)
    fee_type VARCHAR(20) NOT NULL DEFAULT 'both'
        CHECK (fee_type IN ('taker', 'maker', 'both')),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**정산 활용**:

- 거래별 수수료 계산
- 거래쌍별 수수료율 조회
- 수수료 정책 변경 이력 추적

---

### 1.5 `transactions` - 스왑 트랜잭션 테이블

**역할**: 블록체인 스왑 트랜잭션 정보 저장 (블록체인 연동용)

**스키마**:

```sql
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    input_mint VARCHAR(255) NOT NULL,
    output_mint VARCHAR(255) NOT NULL,
    amount BIGINT NOT NULL,
    expected_out_amount BIGINT,
    user_public_key VARCHAR(255) NOT NULL,
    transaction_bytes TEXT NOT NULL,
    quote_response JSONB,
    status VARCHAR(50) NOT NULL DEFAULT 'created',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**정산 활용**:

- 블록체인 출금 내역 추적
- 스왑 거래 내역 관리

---

## 2. 정산을 위해 추가로 필요한 테이블 (제안)

### 2.1 `trade_fees` - 거래별 수수료 내역 테이블 (제안)

**역할**: 각 거래(trade)에서 발생한 수수료를 상세히 기록

**제안 스키마**:

```sql
CREATE TABLE trade_fees (
    id BIGSERIAL PRIMARY KEY,
    trade_id BIGINT NOT NULL REFERENCES trades(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    fee_type VARCHAR(20) NOT NULL CHECK (fee_type IN ('buyer', 'seller')),
    fee_rate DECIMAL(10, 6) NOT NULL,                  -- 적용된 수수료율
    fee_amount DECIMAL(30, 9) NOT NULL,                 -- 수수료 금액
    fee_mint VARCHAR(255) NOT NULL,                     -- 수수료가 차감된 자산 (SOL 또는 USDT)
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**정산 활용**:

- 사용자별 수수료 내역 집계
- 일별/월별 수수료 수익 계산
- 수수료 정산 리포트 생성

---

### 2.2 `settlements` - 정산 내역 테이블 (제안)

**역할**: 일별/월별 정산 요약 정보 저장

**제안 스키마**:

```sql
CREATE TABLE settlements (
    id BIGSERIAL PRIMARY KEY,
    settlement_date DATE NOT NULL,                     -- 정산일 (YYYY-MM-DD)
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,    -- 총 거래량 (USDT)
    total_fees DECIMAL(30, 9) NOT NULL DEFAULT 0,       -- 총 수수료 수익 (USDT)
    base_mint VARCHAR(255),                            -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(settlement_date, settlement_type, base_mint, quote_mint)
);
```

**정산 활용**:

- 일별/월별 거래소 수익 리포트
- 거래쌍별 성과 분석
- 정산 리포트 자동 생성

---

### 2.3 `user_settlements` - 사용자별 정산 내역 테이블 (제안)

**역할**: 사용자별 일별/월별 거래 및 수수료 내역 요약

**제안 스키마**:

```sql
CREATE TABLE user_settlements (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    settlement_date DATE NOT NULL,
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 사용자 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,     -- 사용자 총 거래량 (USDT)
    total_fees_paid DECIMAL(30, 9) NOT NULL DEFAULT 0,  -- 사용자가 지불한 총 수수료
    base_mint VARCHAR(255),                            -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, settlement_date, settlement_type, base_mint, quote_mint)
);
```

**정산 활용**:

- 사용자별 거래 리포트 제공
- VIP 등급 산정 (거래량 기준)
- 세금 신고용 거래 내역 제공

---

## 3. 정산 프로세스 요약

### 3.1 실시간 정산 (거래 발생 시)

1. **거래 발생** → `trades` 테이블에 체결 내역 저장
2. **수수료 계산** → `fee_configs`에서 수수료율 조회
3. **수수료 기록** → `trade_fees` 테이블에 수수료 내역 저장 (제안)
4. **잔고 업데이트** → `user_balances` 테이블 업데이트

### 3.2 일별 정산 (배치 작업)

1. **전일 거래 집계** → `trades` 테이블에서 전일 거래 조회
2. **수수료 집계** → `trade_fees` 테이블에서 전일 수수료 합계
3. **정산 데이터 생성** → `settlements` 테이블에 일별 정산 데이터 저장
4. **사용자별 정산** → `user_settlements` 테이블에 사용자별 일별 정산 저장

### 3.3 월별 정산 (배치 작업)

1. **월간 거래 집계** → `trades` 테이블에서 월간 거래 조회
2. **월간 수수료 집계** → `trade_fees` 테이블에서 월간 수수료 합계
3. **정산 데이터 생성** → `settlements` 테이블에 월별 정산 데이터 저장
4. **사용자별 정산** → `user_settlements` 테이블에 사용자별 월별 정산 저장

---

## 4. 현재 구현된 테이블 vs 제안 테이블

| 테이블명           | 상태      | 정산 활용도                  |
| ------------------ | --------- | ---------------------------- |
| `user_balances`    | ✅ 구현됨 | 높음 - 잔고 관리 필수        |
| `orders`           | ✅ 구현됨 | 높음 - 거래 내역 추적        |
| `trades`           | ✅ 구현됨 | 높음 - 체결 내역 필수        |
| `fee_configs`      | ✅ 구현됨 | 높음 - 수수료 계산 필수      |
| `transactions`     | ✅ 구현됨 | 중간 - 블록체인 연동용       |
| `trade_fees`       | ❌ 미구현 | 높음 - 수수료 상세 기록 필요 |
| `settlements`      | ❌ 미구현 | 높음 - 정산 리포트 생성 필요 |
| `user_settlements` | ❌ 미구현 | 중간 - 사용자 리포트 제공    |

---

## 5. 다음 단계 제안

1. **`trade_fees` 테이블 생성** - 거래별 수수료 상세 기록
2. **정산 배치 작업 구현** - 일별/월별 정산 자동화
3. **`settlements` 테이블 생성** - 정산 요약 데이터 저장
4. **`user_settlements` 테이블 생성** - 사용자별 정산 리포트 제공
