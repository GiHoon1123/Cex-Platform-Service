# 봇 문제 진단 결과

## 실행 시간

2026-01-29 08:57 (KST)

## 확인 사항

### ✅ 1. 시스템 상태

- **Java 애플리케이션**: 실행 중 (PID: 26304)
- **엔진**: 실행 중 (PID: 10145)
- **API 응답**: 정상 (주문 생성 성공)

### ✅ 2. 주문 생성 테스트

다음 주문들이 성공적으로 생성되었습니다:

- **Order ID 467525**: Bot 1 매수 주문 (SOL, 100.0, 1.0)
- **Order ID 467555**: Bot 2 매도 주문 (SOL, 100.0, 1.0)
- **Order ID 467600**: Bot 1 매수 주문 (SOL, 99.0, 1.0)

모든 주문이 `pending` 상태로 생성되었습니다.

### ⚠️ 3. 확인 필요 사항

#### 3.1 엔진 로그 확인

엔진은 `eprintln!`을 사용하여 stderr로 로그를 출력합니다.
다음 로그를 확인해야 합니다:

- `[Engine Thread] OrderCommand::SubmitOrder 수신` - 주문 수신 여부
- `[Engine Thread] 매칭 완료` - 매칭 성공 여부
- `[Engine Thread] trade_executed 이벤트 발행 시도` - Kafka 이벤트 발행 여부
- `[Engine Thread] trade_executed 이벤트 발행 성공` - Kafka 이벤트 발행 성공 여부

**확인 방법**:
엔진이 실행 중인 터미널에서 stderr 출력을 확인하거나,
엔진 프로세스의 stderr를 리다이렉트하여 파일로 저장한 경우 해당 파일을 확인하세요.

#### 3.2 Kafka Consumer 확인

Java 애플리케이션 로그에서 다음을 확인해야 합니다:

- `[Kafka] 체결 이벤트 수신` - 이벤트 수신 여부
- `[Kafka] 체결 이벤트 처리 완료` - 이벤트 처리 완료 여부
- `[Kafka] 주문이 존재하지 않아 체결 처리 스킵` - 주문이 없는 경우 (문제!)

**확인 방법**:
Java 애플리케이션이 실행 중인 터미널의 콘솔 출력을 확인하거나,
로그 파일이 있다면 해당 파일을 확인하세요.

#### 3.3 trades 테이블 확인

다음 SQL을 실행하여 trades 테이블을 확인하세요:

```sql
-- 최근 trades 확인
SELECT id, buy_order_id, sell_order_id, buyer_id, seller_id, price, amount, created_at
FROM trades
ORDER BY id DESC
LIMIT 10;

-- trades 총 개수
SELECT COUNT(*) as total_trades FROM trades;
```

또는 스크립트를 실행하세요:

```bash
./scripts/check-trades.sh
```

#### 3.4 Kafka 토픽 확인

Kafka에 이벤트가 발행되었는지 확인:

```bash
# Kafka 메시지 확인 (최근 10개)
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic order-events \
  --from-beginning \
  --max-messages 10
```

#### 3.5 Kafka Consumer Group Offset 확인

Consumer가 어디까지 읽었는지 확인:

```bash
kafka-consumer-groups --bootstrap-server localhost:9092 \
  --group cex-consumer-group \
  --describe
```

## 가능한 문제 시나리오

### 시나리오 1: 엔진이 주문을 받지 못함

**증상**:

- 주문은 생성되지만 엔진 로그에 `OrderCommand::SubmitOrder 수신`이 없음
- 엔진이 주문을 처리하지 않음

**원인**:

- 엔진 HTTP 엔드포인트 연결 문제
- 네트워크 문제
- 엔진이 주문을 거부함

**해결**:

- 엔진 HTTP 엔드포인트 확인
- 엔진 로그 확인
- 네트워크 연결 확인

### 시나리오 2: 엔진이 주문을 받지만 매칭하지 못함

**증상**:

- 엔진 로그에 `OrderCommand::SubmitOrder 수신`은 있음
- 하지만 `매칭 완료: matches_count=0` 또는 매칭이 없음

**원인**:

- 매수/매도 주문이 서로 매칭되지 않음
- 가격이 일치하지 않음
- 잔고 부족

**해결**:

- 같은 가격의 매수/매도 주문 생성
- 봇 잔고 확인
- 엔진 로그에서 매칭 실패 원인 확인

### 시나리오 3: 엔진이 체결하지만 Kafka 이벤트를 발행하지 못함

**증상**:

- 엔진 로그에 `매칭 완료: matches_count=1`은 있음
- 하지만 `trade_executed 이벤트 발행 시도`가 없거나 실패함

**원인**:

- Kafka 연결 문제
- Kafka Producer 설정 문제
- 네트워크 문제

**해결**:

- Kafka 연결 확인
- Kafka Producer 설정 확인
- 엔진 로그에서 Kafka 에러 확인

### 시나리오 4: Kafka 이벤트는 있지만 Consumer가 처리하지 못함

**증상**:

- Kafka에 `trade_executed` 이벤트는 있음
- 하지만 Java Consumer 로그에 `체결 이벤트 수신`이 없음
- 또는 `주문이 존재하지 않아 체결 처리 스킵` 메시지가 있음

**원인**:

- Consumer Group offset 문제
- 주문이 DB에 없음 (트랜잭션 타이밍 문제)
- Consumer가 실행되지 않음

**해결**:

- Consumer Group offset 확인 및 리셋
- 주문이 DB에 존재하는지 확인
- Consumer 로그 확인

## 다음 단계

1. **엔진 로그 확인**: 엔진이 실행 중인 터미널에서 stderr 출력 확인
2. **Java 애플리케이션 로그 확인**: Java 애플리케이션이 실행 중인 터미널에서 콘솔 출력 확인
3. **trades 테이블 확인**: `./scripts/check-trades.sh` 실행 또는 직접 SQL 실행
4. **Kafka 확인**: Kafka 토픽과 Consumer Group 상태 확인

## 테스트 주문 정보

- **매수 주문**: Order ID 467525, 467600 (Bot 1, SOL, 100.0/99.0, 1.0)
- **매도 주문**: Order ID 467555 (Bot 2, SOL, 100.0, 1.0)

이 주문들이 체결되었는지 확인하세요.
