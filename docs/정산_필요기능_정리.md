# 정산 시스템 필요 기능 정리

## 현재 상황 분석

### ✅ 구현된 것
1. **잔고 스냅샷** (`balance_snapshots`) - 일별 스냅샷 생성 ✅
2. **포지션 스냅샷** (`position_snapshots`) - 일별 스냅샷 생성 ✅
3. **수수료 계산** - 체결 시 수수료 계산 ✅
4. **수수료 설정** (`fee_configs`) - 거래쌍별 수수료율 관리 ✅

### ❌ 미구현된 것
1. **수수료 기록** (`trade_fees` 테이블) - 거래별 수수료 상세 기록 ❌
2. **수수료 수익 집계** - 거래소가 벌어들인 총 수수료 수익 ❌
3. **복식부기 검증** - 모든 거래 내역의 정확성 검증 ❌
4. **정산 리포트** - 일별/월별 정산 리포트 생성 ❌
5. **정산 집계 테이블** (`settlements`, `user_settlements`) ❌

---

## 1. 수수료 기록 및 수익 집계

### 1.1 `trade_fees` 테이블 생성

**목적**: 각 거래에서 발생한 수수료를 상세히 기록하여 정산 시 집계 가능하게 함

**스키마**:
```sql
CREATE TABLE trade_fees (
    id BIGSERIAL PRIMARY KEY,
    trade_id BIGINT NOT NULL REFERENCES trades(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    fee_type VARCHAR(20) NOT NULL CHECK (fee_type IN ('buyer', 'seller')),
    fee_rate DECIMAL(10, 6) NOT NULL,                  -- 적용된 수수료율
    fee_amount DECIMAL(30, 9) NOT NULL,                 -- 수수료 금액
    fee_mint VARCHAR(255) NOT NULL,                     -- 수수료가 차감된 자산 (SOL 또는 USDT)
    trade_value DECIMAL(30, 9) NOT NULL,                 -- 거래 금액 (수수료 계산 기준)
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    INDEX idx_trade_fees_trade_id (trade_id),
    INDEX idx_trade_fees_user_id (user_id),
    INDEX idx_trade_fees_created_at (created_at)
);
```

**구현 위치**: `KafkaOrderEventConsumer.handleTradeExecutedWithSnapshot()`
- 체결 이벤트 처리 시 수수료 계산 후 `trade_fees` 테이블에 저장

### 1.2 수수료 수익 집계

**목적**: 거래소가 벌어들인 총 수수료 수익을 일별/월별로 집계

**집계 항목**:
- 일별 총 수수료 수익 (USDT 기준)
- 월별 총 수수료 수익 (USDT 기준)
- 거래쌍별 수수료 수익 (SOL/USDT, BTC/USDT 등)
- 사용자별 수수료 납부 내역

**구현 위치**: `SettlementService.calculateFeeRevenue()`

---

## 2. 복식부기 검증 (Double-Entry Bookkeeping)

### 2.1 복식부기 원칙

**목적**: 모든 거래 내역이 정확한지 검증 (차변 = 대변)

**검증 항목**:

1. **잔고 검증**
   ```
   초기 잔고 + 입금 - 출금 - 수수료 = 최종 잔고
   ```

2. **거래 검증**
   ```
   매수자 지출 = 매도자 수입
   매수자 수입 = 매도자 지출
   ```

3. **수수료 검증**
   ```
   매수자 수수료 + 매도자 수수료 = 거래소 수익
   ```

4. **전체 시스템 검증**
   ```
   모든 사용자 잔고 합계 + 거래소 수수료 수익 = 초기 자산 총합 + 입금 총합 - 출금 총합
   ```

### 2.2 검증 로직 구현

**구현 위치**: `SettlementService.validateDoubleEntryBookkeeping()`

**검증 시점**:
- 일별 정산 시 (전일 거래 검증)
- 월별 정산 시 (전월 거래 검증)
- 수동 검증 API (관리자용)

**검증 결과**:
- ✅ 통과: 모든 검증 항목 통과
- ⚠️ 경고: 소수점 오차 (0.000001 이하)
- ❌ 실패: 검증 실패 시 상세 에러 로그

---

## 3. 정산 집계 테이블

### 3.1 `settlements` 테이블

**목적**: 일별/월별 정산 요약 정보 저장

**스키마**:
```sql
CREATE TABLE settlements (
    id BIGSERIAL PRIMARY KEY,
    settlement_date DATE NOT NULL,                     -- 정산일 (YYYY-MM-DD)
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,    -- 총 거래량 (USDT)
    total_fee_revenue DECIMAL(30, 9) NOT NULL DEFAULT 0, -- 총 수수료 수익 (USDT)
    total_users BIGINT NOT NULL DEFAULT 0,             -- 거래한 사용자 수
    base_mint VARCHAR(255),                             -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    validation_status VARCHAR(20) DEFAULT 'pending'    -- 'pending', 'validated', 'failed'
        CHECK (validation_status IN ('pending', 'validated', 'failed')),
    validation_error TEXT,                              -- 검증 실패 시 에러 메시지
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    validated_at TIMESTAMPTZ,
    
    UNIQUE(settlement_date, settlement_type, base_mint, quote_mint),
    INDEX idx_settlements_date (settlement_date),
    INDEX idx_settlements_type (settlement_type)
);
```

### 3.2 `user_settlements` 테이블

**목적**: 사용자별 일별/월별 거래 및 수수료 내역 요약

**스키마**:
```sql
CREATE TABLE user_settlements (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    settlement_date DATE NOT NULL,
    settlement_type VARCHAR(20) NOT NULL
        CHECK (settlement_type IN ('daily', 'monthly')),
    total_trades BIGINT NOT NULL DEFAULT 0,            -- 사용자 총 거래 건수
    total_volume DECIMAL(30, 9) NOT NULL DEFAULT 0,     -- 사용자 총 거래량 (USDT)
    total_fees_paid DECIMAL(30, 9) NOT NULL DEFAULT 0,  -- 사용자가 지불한 총 수수료
    base_mint VARCHAR(255),                             -- NULL이면 전체, 특정 자산이면 해당 자산만
    quote_mint VARCHAR(255) DEFAULT 'USDT',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(user_id, settlement_date, settlement_type, base_mint, quote_mint),
    INDEX idx_user_settlements_user_id (user_id),
    INDEX idx_user_settlements_date (settlement_date)
);
```

---

## 4. 정산 프로세스 개선

### 4.1 일별 정산 프로세스 (개선)

**실행 시점**: 매일 자정 (00:00:00)

**처리 순서**:

1. **스냅샷 생성** (기존)
   - `balance_snapshots` 생성
   - `position_snapshots` 생성

2. **거래 집계** (신규)
   - 전일(`settlement_date - 1`) 모든 거래 조회 (`trades` 테이블)
   - 거래 건수, 거래량 집계

3. **수수료 집계** (신규)
   - 전일 모든 수수료 조회 (`trade_fees` 테이블)
   - 총 수수료 수익 계산 (USDT 기준)

4. **복식부기 검증** (신규)
   - 잔고 검증
   - 거래 검증
   - 수수료 검증
   - 전체 시스템 검증

5. **정산 데이터 저장** (신규)
   - `settlements` 테이블에 일별 정산 데이터 저장
   - `user_settlements` 테이블에 사용자별 정산 데이터 저장

6. **검증 실패 시 알림** (신규)
   - 검증 실패 시 관리자에게 알림
   - 에러 로그 상세 기록

### 4.2 월별 정산 프로세스 (신규)

**실행 시점**: 매월 1일 자정 (00:00:00)

**처리 순서**:
1. 전월 모든 일별 정산 데이터 집계
2. 월별 집계 계산
3. 복식부기 검증 (월별)
4. `settlements` 테이블에 월별 정산 데이터 저장
5. `user_settlements` 테이블에 사용자별 월별 정산 저장

---

## 5. 정산 리포트 생성

### 5.1 일별 정산 리포트

**포함 내용**:
- 일별 거래 건수 및 거래량
- 일별 수수료 수익
- 거래쌍별 통계
- 사용자별 상위 거래자
- 복식부기 검증 결과

**형식**: JSON, CSV, PDF (선택 가능)

### 5.2 월별 정산 리포트

**포함 내용**:
- 월별 거래 건수 및 거래량
- 월별 수수료 수익
- 일별 추이 그래프
- 거래쌍별 성과 분석
- 사용자별 월별 통계

### 5.3 사용자별 정산 리포트

**포함 내용**:
- 사용자 거래 내역
- 사용자 수수료 납부 내역
- 사용자 잔고 변동 내역
- 세금 신고용 데이터

---

## 6. 구현 우선순위

### Phase 1: 핵심 기능 (필수)
1. ✅ `trade_fees` 테이블 생성 및 수수료 기록 로직 구현
2. ✅ 수수료 수익 집계 로직 구현
3. ✅ 복식부기 검증 로직 구현
4. ✅ `settlements` 테이블 생성 및 일별 정산 집계 구현

### Phase 2: 집계 및 리포트 (중요)
5. ✅ `user_settlements` 테이블 생성 및 사용자별 정산 집계 구현
6. ✅ 일별 정산 리포트 생성 구현
7. ✅ 월별 정산 프로세스 구현

### Phase 3: 최적화 및 고도화 (선택)
8. ✅ 정산 성능 최적화 (배치 INSERT 등)
9. ✅ 정산 리포트 다양한 형식 지원 (CSV, PDF)
10. ✅ 정산 대시보드 UI 구현

---

## 7. 구현 체크리스트

### 7.1 데이터베이스
- [ ] `trade_fees` 테이블 생성
- [ ] `settlements` 테이블 생성
- [ ] `user_settlements` 테이블 생성
- [ ] 인덱스 생성 (성능 최적화)

### 7.2 엔티티 및 Repository
- [ ] `TradeFee` 엔티티 생성
- [ ] `TradeFeeRepository` 생성
- [ ] `Settlement` 엔티티 생성
- [ ] `SettlementRepository` 생성
- [ ] `UserSettlement` 엔티티 생성
- [ ] `UserSettlementRepository` 생성

### 7.3 서비스 로직
- [ ] `TradeFeeService` - 수수료 기록 로직
- [ ] `SettlementService` - 정산 집계 및 검증 로직
- [ ] `SettlementReportService` - 리포트 생성 로직 (기존 확장)

### 7.4 정산 프로세스
- [ ] `KafkaOrderEventConsumer` - 수수료 기록 추가
- [ ] `SettlementScheduler` - 일별 정산 프로세스 개선
- [ ] `SettlementScheduler` - 월별 정산 프로세스 추가

### 7.5 검증 로직
- [ ] 잔고 검증 로직
- [ ] 거래 검증 로직
- [ ] 수수료 검증 로직
- [ ] 전체 시스템 검증 로직

### 7.6 API 엔드포인트
- [ ] GET `/api/settlement/revenue/daily` - 일별 수수료 수익 조회
- [ ] GET `/api/settlement/revenue/monthly` - 월별 수수료 수익 조회
- [ ] GET `/api/settlement/validate/{date}` - 정산 검증 실행
- [ ] GET `/api/settlement/report/daily/{date}` - 일별 리포트 생성
- [ ] GET `/api/settlement/report/monthly/{year}/{month}` - 월별 리포트 생성

---

## 8. 예상 처리량 및 성능

### 8.1 일별 정산 처리량

**가정**:
- 엔진 TPS: 1,000,000 TPS
- 하루 거래량: 86,400,000,000 건 (약 864억 건)
- 사용자 수: 1,000,000 명
- 거래쌍 수: 10개

**처리 시간 추정**:
- 스냅샷 생성: 약 1-2분 (배치 INSERT 사용 시)
- 거래 집계: 약 5-10분 (인덱스 활용)
- 수수료 집계: 약 3-5분 (인덱스 활용)
- 복식부기 검증: 약 10-20분 (대량 데이터 검증)
- **총 처리 시간**: 약 20-40분

### 8.2 최적화 방안

1. **배치 INSERT 사용** - 스냅샷 생성 속도 10-20배 향상
2. **인덱스 최적화** - 집계 쿼리 속도 향상
3. **병렬 처리** - 거래 집계와 수수료 집계 병렬 실행
4. **캐싱** - 자주 조회하는 데이터 캐싱

---

## 9. 다음 단계

1. **`trade_fees` 테이블 및 수수료 기록 로직 구현** (최우선)
2. **복식부기 검증 로직 구현** (정확도 보장)
3. **정산 집계 테이블 및 로직 구현** (수익 집계)
4. **정산 리포트 생성 구현** (리포트 제공)
5. **성능 최적화** (배치 INSERT 등)
